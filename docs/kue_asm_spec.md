# KUE-CHIP2アセンブリ言語仕様

KUE-CHIP2は京都大学が開発した8ビット教育用マイクロプロセッサです。

## 目次

- [アーキテクチャ概要](#アーキテクチャ概要)
- [レジスタ](#レジスタ)
- [メモリ空間](#メモリ空間)
- [アドレッシングモード](#アドレッシングモード)
- [命令セット](#命令セット)
- [フラグ](#フラグ)
- [命令フォーマット](#命令フォーマット)

## アーキテクチャ概要

- **データ幅**: 8ビット
- **メモリ空間**: 512バイト（9ビットアドレス）
- **命令長**: 1バイトまたは2バイト
- **レジスタ**: ACC、IX、PC、IR、FLAG

## レジスタ

| レジスタ | 名称 | 説明 |
|---------|------|------|
| ACC | アキュムレータ | 演算の主レジスタ（8ビット） |
| IX | インデックスレジスタ | 演算・アドレス修飾用（8ビット） |
| PC | プログラムカウンタ | 次の命令アドレス（8ビット） |
| IR | 命令レジスタ | 現在実行中の命令（8ビット） |
| FLAG | フラグレジスタ | CF, VF, NF, ZF（4ビット） |

## メモリ空間

```text
0x000 - 0x0FF (256バイト): プログラム領域
0x100 - 0x1FF (256バイト): データ領域
```

- プログラムは**プログラム領域**（0x000-0x0FF）にのみ配置可能
- データはプログラム領域とデータ領域の両方にアクセス可能

## アドレッシングモード

### アドレッシングモード表

| 記法 | 名称 | 説明 | 例 |
|------|------|------|-----|
| `ACC`, `IX` | レジスタ直接 | レジスタの値を使用 | `LD ACC, IX` |
| `d` | 即値 | 8ビット即値 | `LD ACC, 5` |
| `[d]` | 絶対（プログラム領域） | プログラム領域のアドレスd | `LD ACC, [10H]` |
| `(d)` | 絶対（データ領域） | データ領域のアドレスd | `LD ACC, (80H)` |
| `[IX+d]` | インデックス修飾（プログラム） | IX + d のアドレス（プログラム領域） | `LD ACC, [IX+5]` |
| `(IX+d)` | インデックス修飾（データ） | IX + d のアドレス（データ領域） | `LD ACC, (IX+5)` |

### アドレッシングモード対応表

| モード | ACC | IX | d |　[d] |　(d) |　[IX+d] | (IX+d) |
|------|------|------|-----|------|------|------|------|
| {ea} | y | y | y | y | y | y | y |
| {reg} | y | y | n | n | n | n | n |
| {imm} | n | n | y | n | n | n | n |
| {ma} | n | n | n | y | y | y | y |

## 命令セット

### 制御命令

| ニーモニック | オペコード | 説明 |
|-------------|-----------|------|
| `NOP` | 0x00 | 何もしない |
| `HLT` | 0x0F | プログラム停止 |

### I/O命令

| ニーモニック | オペコード | 説明 |
|-------------|-----------|------|
| `IN` | 0x1F | 入力バッファ → ACC |
| `OUT` | 0x10 | ACC → 出力バッファ |

### フラグ操作命令

| ニーモニック | オペコード | 説明 |
|-------------|-----------|------|
| `SCF` | 0x2F | キャリーフラグをセット |
| `RCF` | 0x20 | キャリーフラグをクリア |

### 分岐命令

| ニーモニック | オペコード | 条件 |
|-------------|-----------|------|
| `BA d` | 0x30 | 無条件分岐 |
| `BZ d` | 0x39 | ゼロフラグが1なら分岐 |
| `BNZ d` | 0x31 | ゼロフラグが0なら分岐 |
| `BC d` | 0x3D | キャリーフラグが1なら分岐 |
| `BNC d` | 0x35 | キャリーフラグが0なら分岐 |
| `BN d` | 0x3A | ネガティブフラグが1なら分岐 |
| `BP d` | 0x33 | ネガティブフラグが0なら分岐（正） |
| `BVF d` | 0x38 | オーバーフローフラグが1なら分岐 |
| `BZP d` | 0x32 | ゼロまたは正なら分岐 |
| `BZN d` | 0x3B | ゼロまたは負なら分岐 |
| `BGE d` | 0x36 | 以上なら分岐 |
| `BLT d` | 0x3E | 未満なら分岐 |
| `BGT d` | 0x37 | より大きいなら分岐 |
| `BLE d` | 0x3F | 以下なら分岐 |
| `BNI d` | 0x34 | 入力なしなら分岐 |
| `BNO d` | 0x3C | 出力なしなら分岐 |

### データ転送命令

| ニーモニック | オペコード範囲 | 説明 |
|-------------|--------------|------|
| `LD ACC, {ea}` | 0x60-0x67 | ACCへロード |
| `LD IX, {ea}` | 0x68-0x6F | IXへロード |
| `ST ACC, {ma}` | 0x74-0x77 | ACCからストア |
| `ST IX, {ma}` | 0x7C-0x7F | IXからストア |

### 算術演算命令

| ニーモニック | オペコード範囲 | 説明 |
|-------------|--------------|------|
| `ADD {reg}, {ea}` | 0xB0-0xBF | 加算 |
| `ADC {reg}, {ea}` | 0x90-0x9F | キャリー付き加算 |
| `SUB {reg}, {ea}` | 0xA0-0xAF | 減算 |
| `SBC {reg}, {ea}` | 0x80-0x8F | キャリー付き減算 |
| `CMP {reg}, {ea}` | 0xF0-0xFF | 比較（結果は破棄） |

### 論理演算命令

| ニーモニック | オペコード範囲 | 説明 |
|-------------|--------------|------|
| `AND {reg}, {ea}` | 0xE0-0xEF | 論理積 |
| `OR {reg}, {ea}` | 0xD0-0xDF | 論理和 |
| `EOR {reg}, {ea}` | 0xC0-0xCF | 排他的論理和 |

### シフト・ローテート命令

| ニーモニック | オペコード | 説明 |
|-------------|-----------|------|
| `SRA {reg}` | 0x40, 0x48 | 算術右シフト |
| `SLA {reg}` | 0x41, 0x49 | 算術左シフト |
| `SRL {reg}` | 0x42, 0x4A | 論理右シフト |
| `SLL {reg}` | 0x43, 0x4B | 論理左シフト |
| `RRA {reg}` | 0x44, 0x4C | 算術右ローテート |
| `RLA {reg}` | 0x45, 0x4D | 算術左ローテート |
| `RRL {reg}` | 0x46, 0x4E | 論理右ローテート |
| `RLL {reg}` | 0x47, 0x4F | 論理左ローテート |

## フラグ

| フラグ | 名称 | 説明 |
|-------|------|------|
| CF | キャリーフラグ | 演算で桁上がり/桁下がりが発生 |
| VF | オーバーフローフラグ | 符号付き演算でオーバーフロー発生 |
| NF | ネガティブフラグ | 演算結果が負（最上位ビットが1） |
| ZF | ゼロフラグ | 演算結果が0 |

## 命令フォーマット

### 1バイト命令

```text
+---+---+---+---+---+---+---+---+
| オペコード                    |
+---+---+---+---+---+---+---+---+
```

例: `NOP`, `HLT`, `IN`, `OUT`

### 2バイト命令

```text
1バイト目:
+---+---+---+---+---+---+---+---+
| オペコード | アドレスモード    |
+---+---+---+---+---+---+---+---+

2バイト目:
+---+---+---+---+---+---+---+---+
| オペランド（アドレス/即値）    |
+---+---+---+---+---+---+---+---+
```

例: `LD ACC, (80H)`, `BA 10H`

## 命令実行フェーズ

各命令は3-5個のフェーズ（P0-P4）で実行されます。

- **P0**: 命令フェッチ（PC → IR）
- **P1**: PC インクリメント
- **P2-P4**: 命令固有の処理

## コメント

行の `*` の後の内容はコメントとして解釈されます

```asm
* ここはコメントです
HLT * ここもコメントです
```

## プログラム例

```asm
* 1から10までの和を計算
        LD ACC, 0
        ST ACC, (80H)      * sum = 0
        LD IX, 1
        ST IX, (81H)       * counter = 1

LOOP:   LD ACC, (80H)
        ADD ACC, (81H)
        ST ACC, (80H)      * sum += counter

        LD IX, (81H)
        ADD IX, 1
        ST IX, (81H)       * counter++

        CMP IX, 11
        BLT LOOP           * if counter < 11 goto LOOP

        HLT
```

## 参考資料

- KUE-CHIP2 教育用ボード リファレンスマニュアル（京都高度技術研究所, 1993年6月25日 v1.11）
- KUE-CHIP2 設計ドキュメント（神原弘之他, 1993年1月16日, 京都高度技術研究所, v1.10）
